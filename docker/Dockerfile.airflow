FROM apache/airflow:2.8.4-python3.11

USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*
USER airflow

COPY ./../pyproject.toml /opt/airflow/
RUN pip install --no-cache-dir poetry && \
    cd /opt/airflow && \
    poetry export --format requirements.txt --output requirements.txt --without-hashes && \
    pip install --no-cache-dir -r requirements.txt && \
    rm requirements.txt

ENV PYTHONPATH=/opt/airflow


